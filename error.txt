error:
line 40, in <module>
    con.execute(f"""
duckdb.duckdb.BinderException: Binder Error: No function matches the given name and argument types 'trunc(VARCHAR)'. You might need to add explicit type casts.
        Candidate functions:
        trunc(TINYINT) -> TINYINT
        trunc(SMALLINT) -> SMALLINT
        trunc(INTEGER) -> INTEGER
        trunc(BIGINT) -> BIGINT
        trunc(HUGEINT) -> HUGEINT
        trunc(FLOAT) -> FLOAT
        trunc(DOUBLE) -> DOUBLE
        trunc(DECIMAL) -> DECIMAL
        trunc(UTINYINT) -> UTINYINT
        trunc(USMALLINT) -> USMALLINT
        trunc(UINTEGER) -> UINTEGER
        trunc(UBIGINT) -> UBIGINT
        trunc(UHUGEINT) -> UHUGEINT


LINE 7:        CAST(TRUNC(PHONEPREV) AS BIGINT) AS PHONEPREV,

program:
import duckdb
import datetime
from CIS_PY_READER import host_parquet_path, parquet_output_path, csv_output_path

batch_date = (datetime.date.today() - datetime.timedelta(days=1))
year, month, day = batch_date.year, batch_date.month, batch_date.day
CURDD = year
CURMM = month
CURYY = year

# -----------------------------
# CONNECT DUCKDB
# -----------------------------
con = duckdb.connect()

# -----------------------------
# CREATE DUCKDB TABLES FROM PARQUET
# -----------------------------
con.execute(f"""
CREATE OR REPLACE TABLE PHONE AS
SELECT *,
       MAKEDATE(UPDTYY, UPDTMM, UPDTDD) AS RECDT
FROM '{host_parquet_path("UNLOAD_CIPHONET_FB.parquet")}'
""")

# -----------------------------
# FILTER LOGIC (SAS IF &CURDD = UPDTDD AND &CURMM = UPDTMM THEN &CURYY > UPDTYY)
# -----------------------------
con.execute(f"""
CREATE OR REPLACE TABLE PHONE_FILTERED AS
SELECT 
    BANKNO,
    APPLCODE,
    CUSTNO,
    PHONETYPE,
    PHONEPAC,
    PHONEPREV,
    INDORG,
    FIRSTDATE,
    '0' AS PROMPTNO,
    PROMTSOURCE,
    PROMPTDATE, 
    PROMPTTIME, 
    UPDSOURCE,  
    RECDT AS UPDDATE,    
    UPDTIME,    
    UPDOPER,    
    TRXAPPLCODE,
    TRXAPPLNO,  
    NEWPHONE AS PHONENEW   
FROM PHONE
WHERE EXTRACT(DAY FROM RECDT) = {CURDD}
  AND EXTRACT(MONTH FROM RECDT) = {CURMM}
  AND EXTRACT(YEAR FROM RECDT) < {CURYY}
ORDER BY CUSTNO
""")

print("CIS (first 5 rows):")
print(con.execute("SELECT * FROM PHONE_FILTERED LIMIT 500").fetchdf())
