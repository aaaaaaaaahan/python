CASE WHEN OUTSTBALS = '-' THEN CAST(OUTSTBAL AS DOUBLE) * -1 ELSE CAST(OUTSTBAL AS DOUBLE) END AS OUTSTBAL_FIX,
CASE WHEN AUTHLIMS = '-' THEN CAST(AUTHLIM AS DOUBLE) * -1 ELSE CAST(AUTHLIM AS DOUBLE) END AS AUTHLIM_FIX,

CASE WHEN OUTSTBALS = '-' THEN CAST(OUTSTBAL AS DOUBLE) * -1 ELSE CAST(OUTSTBAL AS DOUBLE) END
+ CASE WHEN AUTHLIMS = '-' THEN CAST(AUTHLIM AS DOUBLE) * -1 ELSE CAST(AUTHLIM AS DOUBLE) END
AS TOTALBAL


con.execute("""
CREATE OR REPLACE TABLE acctf1 AS
SELECT
    -- Handle swap logic: SUPPCARD and PRIMCARD
    CASE 
        WHEN GUARNTOR IS NOT NULL AND TRIM(GUARNTOR) <> '' AND GUARNTOR <> '0000000000000000'
        THEN GUARNTOR
        ELSE PRIMCARD
    END AS PRIMCARD,

    CASE 
        WHEN GUARNTOR IS NOT NULL AND TRIM(GUARNTOR) <> '' AND GUARNTOR <> '0000000000000000'
        THEN PRIMCARD
        ELSE NULL
    END AS SUPPCARD,

    GUARNTOR,
    PRIMPROD,
    PRODTYPE,
    SUBSTRING(PRIMCARD, 1, 14) AS CARDACCT,

    -- Cast string columns to numeric
    CASE WHEN OUTSTBALS = '-' THEN CAST(OUTSTBAL AS DOUBLE) * -1 ELSE CAST(OUTSTBAL AS DOUBLE) END AS OUTSTBAL_FIX,
    CASE WHEN AUTHLIMS = '-' THEN CAST(AUTHLIM AS DOUBLE) * -1 ELSE CAST(AUTHLIM AS DOUBLE) END AS AUTHLIM_FIX,

    -- Total
    (CASE WHEN OUTSTBALS = '-' THEN CAST(OUTSTBAL AS DOUBLE) * -1 ELSE CAST(OUTSTBAL AS DOUBLE) END)
    + (CASE WHEN AUTHLIMS = '-' THEN CAST(AUTHLIM AS DOUBLE) * -1 ELSE CAST(AUTHLIM AS DOUBLE) END)
    AS TOTALBAL

FROM acct_raw
WHERE PRIMCARD <> '0000000000000000'
""")
