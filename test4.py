# Step 1: Filter exact like SAS
con.execute("""
    CREATE OR REPLACE TABLE OKAY AS
    SELECT *
    FROM RMKFILE
    WHERE TRIM(APPL_CODE) = 'CUST'
""")

# Step 2: Emulate PROC SORT NODUPKEY with DUPOUT
con.execute("""
    CREATE OR REPLACE TABLE OKAY_SORTED AS
    SELECT *
    FROM OKAY
    QUALIFY ROW_NUMBER() OVER (PARTITION BY APPL_NO, EFF_DATE ORDER BY EFF_DATE) = 1
""")

con.execute("""
    CREATE OR REPLACE TABLE DUPNI AS
    SELECT *
    FROM OKAY
    EXCEPT ALL
    SELECT *
    FROM OKAY_SORTED
""")

# Step 3: Generate group and eff_date_add for DUPNI
con.execute("""
    CREATE OR REPLACE TABLE LATEST AS
    SELECT 
        *,
        ROW_NUMBER() OVER (PARTITION BY APPL_NO ORDER BY EFF_DATE) AS EFF_DATE_ADD
    FROM DUPNI
""")
